{% extends "home.html" %}
{% load static %}

{% block title %}Kataloq | AS-AVTO | Avtomobil Ehtiyat Hissələri{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/catalogue.css' %}">
<style>
    .results-table tbody tr {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .results-table tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
    
    .back-to-results-btn {
        display: flex;
        align-items: center;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 8px 16px;
        margin-bottom: 20px;
        cursor: pointer;
        font-weight: 500;
        color: #333;
        transition: all 0.2s;
    }
    
    .back-to-results-btn:hover {
        background-color: #e9e9e9;
    }
    
    .back-to-results-btn i {
        margin-right: 8px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Main Content -->
<main class="catalogue-page">
    <div class="container">
        <div class="catalogue-banner">
            <h1 class="catalogue-title">Məhsul Kataloqu</h1>
            <p class="catalogue-subtitle">Avtomobil ehtiyat hissələrini axtarın və tapın</p>
        </div>

        <!-- Axtarış bölməsi -->
        <div class="search-section">
            <form id="product-search-form" action="{% url 'catalogue_search' %}" method="GET">
                <input type="hidden" name="search_type" value="product_no">
                <div class="form-group">
                    <label for="query">Məhsul Kodu ilə Axtarış (OEM, AS kod, Brend kod)</label>
                    <div class="search-input-wrapper">
                        <input type="text" id="query" name="query" placeholder="Kodu daxil edin..." required>
                        <button type="submit" class="search-btn">
                            <i class="fas fa-search"></i> Axtar
                        </button>
                    </div>
                    <small class="form-hint">OEM, AS kodları və brend kodları ilə axtarış edə bilərsiniz</small>
                </div>
            </form>
        </div>

        <!-- Axtarış nəticələri bölməsi - birbaşa səhifədə göstərilir -->
        <div class="search-results-section" id="search-results-section">
            {% if mehsullar %}
            <div class="search-summary">
                <div class="search-info">
                    {% if search_query %}
                        <div class="search-term">
                            <strong>Axtarış:</strong> "{{ search_query }}"
                        </div>
                    {% endif %}
                    
                    {% if selected_category or selected_brand %}
                        <div class="search-filters">
                            <strong>Filterlər:</strong>
                            {% if selected_category %}<span class="filter-badge">Kateqoriya: {{ selected_category }}</span>{% endif %}
                            {% if selected_brand %}<span class="filter-badge">Brend: {{ selected_brand }}</span>{% endif %}
                        </div>
                    {% endif %}
                    
                    <div class="search-count">
                        <strong>Tapılan nəticələr:</strong> <span class="highlight">{{ mehsullar|length }}</span>
                    </div>
                </div>

                <!-- Filter Section -->
                <div class="filters-accordion">
                    <button class="accordion-button" id="filtersToggle">
                        <i class="fas fa-filter"></i> Filtrləmə
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="accordion-content" id="filtersPanel">
                        <form action="{% url 'catalogue_search' %}" method="GET" class="filter-form">
                            <input type="hidden" name="search_type" value="{{ search_type }}">
                            {% if search_query %}
                                <input type="hidden" name="query" value="{{ search_query }}">
                            {% endif %}
                            
                            <div class="filter-row">
                                <div class="filter-group">
                                    <label for="category-filter">Kateqoriya</label>
                                    <select name="category" id="category-filter" class="form-select">
                                        <option value="">Bütün kateqoriyalar</option>
                                        {% for kateqoriya in kateqoriyalar %}
                                            <option value="{{ kateqoriya.adi }}" {% if selected_category == kateqoriya.adi %}selected{% endif %}>
                                                {{ kateqoriya.adi }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                                
                                <div class="filter-group">
                                    <label for="brand-filter">Brend</label>
                                    <select name="brand" id="brand-filter" class="form-select">
                                        <option value="">Bütün brendlər</option>
                                        {% for brend in brendler %}
                                            <option value="{{ brend.adi }}" {% if selected_brand == brend.adi %}selected{% endif %}>
                                                {{ brend.adi }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            
                            <div class="filter-actions">
                                <button type="submit" class="btn-filter-apply">
                                    <i class="fas fa-check"></i> Tətbiq et
                                </button>
                                <a href="{% url 'catalogue' %}" class="btn-filter-reset">
                                    <i class="fas fa-undo"></i> Sıfırla
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Məhsul tək olduqda -->
            {% if mehsullar|length == 1 %}
                {% for mehsul in mehsullar %}
                <div class="single-product-result">
                    <div class="product-detail-card">
                        <div class="product-detail-grid">
                            <div class="product-image">
                                {% if mehsul.sekil %}
                                    <img src="{{ mehsul.sekil.url }}" alt="{{ mehsul.adi }}">
                                {% else %}
                                    <div class="no-image">
                                        <i class="fas fa-image"></i>
                                    </div>
                                {% endif %}
                            </div>

                            <div class="product-info">
                                <h2 class="product-title">{{ mehsul.adi }}</h2>
                                
                                <div class="product-specs">
                                    {% if mehsul.brend %}
                                        <div class="spec-item">
                                            <span class="label">Brend:</span>
                                            <span class="value">{{ mehsul.brend.adi }}</span>
                                        </div>
                                    {% endif %}
                                    
                                    {% if mehsul.marka %}
                                        <div class="spec-item">
                                            <span class="label">Model:</span>
                                            <span class="value">{{ mehsul.marka.adi }}</span>
                                        </div>
                                    {% endif %}
                                    
                                    {% if mehsul.oem %}
                                        <div class="spec-item">
                                            <span class="label">OEM:</span>
                                            <span class="value">{{ mehsul.oem }}</span>
                                        </div>
                                    {% endif %}
                                    
                                    {% if mehsul.as_kodu %}
                                        <div class="spec-item">
                                            <span class="label">AS:</span>
                                            <span class="value">{{ mehsul.as_kodu }}</span>
                                        </div>
                                    {% endif %}
                                    
                                    {% if mehsul.brend_kod %}
                                        <div class="spec-item">
                                            <span class="label">BREND KODU:</span>
                                            <span class="value">{{ mehsul.brend_kod }}</span>
                                        </div>
                                    {% endif %}
                                    
                                    {% if mehsul.oem_kodlar.all %}
                                        <div class="spec-item oem-list">
                                            <span class="label">Dəyişən OEM Kodlar:</span>
                                            <div class="value oem-codes">
                                                {% for oem in mehsul.oem_kodlar.all %}
                                                    <span class="oem-code">{{ oem.kod }}</span>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    <div class="spec-item">
                                        <span class="label">Qiymət:</span>
                                        <span class="value price">{{ mehsul.qiymet }} AZN</span>
                                    </div>

                                    <div class="spec-item">
                                        <span class="label">Stok:</span>
                                        <span class="value stock">
                                            {% if mehsul.stok == 0 %}
                                                <span class="stock-badge out">Yoxdur</span>
                                            {% elif mehsul.stok <= 20 %}
                                                <span class="stock-badge low">Az var</span>
                                            {% else %}
                                                <span class="stock-badge in">Var</span>
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>

                                <div class="product-actions">
                                    <a href="{% url 'mehsul_etrafli' mehsul.adi|slugify mehsul.oem|slugify mehsul.brend_kod|slugify mehsul.id %}" class="btn-view">
                                        <i class="fas fa-eye"></i> Ətraflı
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Çoxlu məhsul cədvəli -->
                <div class="results-table-wrapper">
                    <table class="results-table">
                        <thead>
                            <tr>
                                <th class="col-image">Şəkil</th>
                                <th class="col-name">Məhsul</th>
                                <th class="col-brand">Brend/Model</th>
                                <th class="col-codes">Kodlar</th>
                                <th class="col-price">Qiymət</th>
                                <th class="col-stock">Stok</th>
                                <th class="col-actions">Əməliyyatlar</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mehsul in mehsullar %}
                                <tr data-url="{% url 'mehsul_etrafli' mehsul.adi|slugify mehsul.oem|slugify mehsul.brend_kod|slugify mehsul.id %}" class="product-row" data-id="{{ mehsul.id }}">
                                    <!-- Şəkil -->
                                    <td class="col-image">
                                        {% if mehsul.sekil %}
                                            <img src="{{ mehsul.sekil.url }}" alt="{{ mehsul.adi }}" class="product-image">
                                        {% else %}
                                            <div class="no-image">
                                                <i class="fas fa-image"></i>
                                            </div>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Məhsul adı -->
                                    <td class="col-name">
                                        <h3 class="product-name">{{ mehsul.adi }}</h3>
                                    </td>
                                    
                                    <!-- Brend/Model -->
                                    <td class="col-brand">
                                        <div class="brand-info">
                                            {% if mehsul.brend %}
                                                <div class="brand"><strong>Brend:</strong> {{ mehsul.brend.adi }}</div>
                                            {% endif %}
                                            
                                            {% if mehsul.marka %}
                                                <div class="model"><strong>Model:</strong> {{ mehsul.marka.adi }}</div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    
                                    <!-- Kodlar -->
                                    <td class="col-codes">
                                        <div class="product-codes">
                                            {% if mehsul.oem %}
                                                <div class="code-item"><strong>OEM:</strong> {{ mehsul.oem }}</div>
                                            {% endif %}
                                            
                                            {% if mehsul.as_kodu %}
                                                <div class="code-item"><strong>AS:</strong> {{ mehsul.as_kodu }}</div>
                                            {% endif %}
                                            
                                            {% if mehsul.brend_kod %}
                                                <div class="code-item"><strong>BREND:</strong> {{ mehsul.brend_kod }}</div>
                                            {% endif %}
                                            
                                            <!-- Əlavə OEM kodları -->
                                            {% if mehsul.oem_kodlar.all %}
                                                <div class="extra-codes">
                                                    <button class="toggle-codes stop-propagation" data-target="codes-{{ mehsul.id }}">
                                                        <i class="fas fa-plus-circle"></i> Əlavə OEM Kodlar ({{ mehsul.oem_kodlar.all|length }})
                                                    </button>
                                                    <div class="hidden-codes" id="codes-{{ mehsul.id }}">
                                                        {% for kod in mehsul.oem_kodlar.all %}
                                                            <div class="code-item extra">{{ kod.kod }}</div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                    
                                    <!-- Qiymət -->
                                    <td class="col-price">
                                        <div class="product-price">{{ mehsul.qiymet }} AZN</div>
                                    </td>
                                    
                                    <!-- Stok -->
                                    <td class="col-stock">
                                        {% if mehsul.stok == 0 %}
                                            <span class="stock-badge out">Yoxdur</span>
                                        {% elif mehsul.stok <= 20 %}
                                            <span class="stock-badge low">Az var</span>
                                        {% else %}
                                            <span class="stock-badge in">Var</span>
                                        {% endif %}
                                    </td>
                                    
                                    <!-- Əməliyyatlar -->
                                    <td class="col-actions">
                                        <div class="action-buttons">
                                            <a href="{% url 'mehsul_etrafli' mehsul.adi|slugify mehsul.oem|slugify mehsul.brend_kod|slugify mehsul.id %}" class="btn-view">
                                                <i class="fas fa-eye"></i> Ətraflı
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% endif %}
            {% elif search_submitted %}
                <!-- Nəticə tapılmadı -->
                <div class="no-results-msg">
                    <div class="no-results-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2>Məhsul tapılmadı</h2>
                    <p>Axtarışınıza uyğun heç bir məhsul tapılmadı. Zəhmət olmasa, parametrləri dəyişərək yenidən cəhd edin.</p>
                </div>
            {% endif %}
        </div>

        <!-- Yükləmə indikatoru -->
        <div class="loading-spinner" id="loading-spinner">
            <div class="spinner"></div>
            <p>Nəticələr yüklənir...</p>
        </div>

        <!-- Populyar brendlər -->
        <div class="popular-brands">
            <h2 class="section-title">Populyar Brendlər</h2>
            <div class="brands-grid">
                {% for brend in brendler %}
                    {% if brend.sekil %}
                        <a href="{% url 'catalogue_search' %}?search_type=application&brand={{ brend.adi }}" class="brand-item">
                            <img src="{{ brend.sekil.url }}" alt="{{ brend.adi }}">
                        </a>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/catalogue.js' %}"></script>
<script>
    // Loading göstəricisi
    const loadingSpinner = document.getElementById('loading-spinner');
    
    // Form submission
    document.getElementById('product-search-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Yüklənmə indikatorunu göstər
        loadingSpinner.style.display = 'flex';
        
        // Formu göndər
        this.submit();
    });
    
    // Filter accordion
    const filtersToggle = document.getElementById('filtersToggle');
    if (filtersToggle) {
        filtersToggle.addEventListener('click', function() {
            const panel = document.getElementById('filtersPanel');
            const button = this;
            
            if (panel.style.maxHeight) {
                panel.style.maxHeight = null;
                button.classList.remove('active');
            } else {
                panel.style.maxHeight = panel.scrollHeight + 'px';
                button.classList.add('active');
            }
        });
    }
    
    // Əlavə kodlar toggle
    const toggleCodeButtons = document.querySelectorAll('.toggle-codes');
    if (toggleCodeButtons.length > 0) {
        toggleCodeButtons.forEach(button => {
            button.addEventListener('click', function(e) {
                // Hədəfə klikləmə event-in yayılmasını dayandırır
                e.stopPropagation();
                
                const targetId = this.getAttribute('data-target');
                const codesContainer = document.getElementById(targetId);
                
                if (codesContainer.style.display === 'block') {
                    codesContainer.style.display = 'none';
                    const codesCount = codesContainer.querySelectorAll('.code-item').length;
                    this.innerHTML = `<i class="fas fa-plus-circle"></i> Əlavə OEM Kodlar (${codesCount})`;
                } else {
                    codesContainer.style.display = 'block';
                    this.innerHTML = '<i class="fas fa-minus-circle"></i> Gizlət';
                }
            });
        });
    }
    
    // Məhsul sırası kliklənmə
    const productRows = document.querySelectorAll('.product-row');
    if (productRows.length > 0) {
        productRows.forEach(row => {
            row.addEventListener('click', function(e) {
                // Əgər kliklənən element stopPropagation sinfidə deyilsə
                if (!e.target.closest('.stop-propagation')) {
                    const url = this.getAttribute('data-url');
                    if (url) {
                        window.location.href = url;
                    }
                }
            });
        });
    }
    
    // Səhifə yükləndiyində yüklənmə indikatorunu gizlət
    window.addEventListener('load', function() {
        loadingSpinner.style.display = 'none';
    });
</script>
{% endblock %}