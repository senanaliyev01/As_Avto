{% extends 'base.html' %}
{% load static %}

{% block title %}Səbət{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
       
        <h1>Səbətim</h1>
    </div>

    {% if sebet %}
    <div class="cart-container">
        <table>
            <thead>
                <tr>
                    <th>Məhsul</th>
                    <th>Firma</th>
                    <th>Avtomobil</th>
                    <th>Brend</th>
                    <th>OEM</th>
                    <th>Mövcudluq</th>
                    <th>Qiymət</th>
                    <th>Miqdar</th>
                    <th>Cəmi</th>
                    <th>Sil</th>
                </tr>
            </thead>
            <tbody>
                {% for item in sebet %}
                <tr data-item-id="{{ item.id }}" data-price="{{ item.mehsul.formatted_qiymet }}">
                    <td>{{ item.mehsul.adi }}</td>
                    <td>{{ item.mehsul.brend.adi }}</td>
                    <td>{{ item.mehsul.marka.adi }}</td>
                    <td>{{ item.mehsul.brend_kod }}</td>
                    <td>{{ item.mehsul.oem }}</td>
                    <td>
                        {% if item.mehsul.stok == 0 %}
                            <span class="stock-status out-of-stock">
                                 Yoxdur
                            </span>
                        {% elif item.mehsul.stok <= 20 %}
                            <span class="stock-status low-stock">
                                Az var
                            </span>
                        {% else %}
                            <span class="stock-status in-stock">
                               Var
                            </span>
                        {% endif %}
                    </td>
                    <td class="price">{{ item.mehsul.formatted_qiymet }} AZN</td>
                    <td>
                        <div class="quantity-controls">
                            <button type="button" class="quantity-btn minus" onclick="updateQuantity({{ item.id }}, -1)">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" 
                                   class="quantity-input" 
                                   value="{{ item.miqdar }}"
                                   min="1"
                                   data-item-id="{{ item.id }}"
                                   onchange="handleQuantityInput(this)"
                                   onkeyup="if(event.key === 'Enter') handleQuantityInput(this)"
                                   onblur="handleQuantityInput(this)"
                                   style="width: 60px; text-align: center;">
                            <button type="button" class="quantity-btn plus" onclick="updateQuantity({{ item.id }}, 1)">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </td>
                    <td class="item-total">{{ item.cemi }} AZN</td>
                    <td>
                        <form action="{% url 'sebetden_sil' item.id %}" method="post" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="delete-btn" title="Sil" onclick="return confirm('Məhsulu silmək istədiyinizə əminsiniz?')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            {% comment %} <tfoot>
                <tr>
                    <td colspan="11" style="text-align: center; padding: 1.5rem;">
                        <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(145deg, #0a1929, #1a2942); padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
                            <strong style="color: #64ffda; font-size: 1.2rem;">Ümumi Cəmi:</strong>
                            <span id="total-amount" style="color: white; font-size: 1.2rem; font-weight: 600;">{{ cemi_mebleg }} AZN</span>
                        </div>
                    </td>
                </tr>
            </tfoot> {% endcomment %}
        </table>

        <div colspan="11" style="text-align: center; padding: 1.5rem;">
            <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(145deg, #0a1929, #1a2942); padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
                <strong style="color: #64ffda; font-size: 1.2rem;">Ümumi Cəmi:</strong>
            <span id="total-amount" style="color: white; font-size: 1.2rem; font-weight: 600;">{{ cemi_mebleg }} AZN</span>
        </div>


        <div class="cart-actions">
            <form action="{% url 'sifarisi_gonder' %}" method="post" style="display: inline;" onsubmit="return handleOrderSubmit(event)">
                {% csrf_token %}
                <button type="submit" class="order-btn">
                    <i class="fas fa-shopping-cart"></i>
                    Sifarişi Təsdiqlə
                </button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <i class="fas fa-shopping-cart"></i>
        <p>Səbətiniz boşdur</p>
        <a href="{% url 'products_list' %}" class="continue-shopping">
            Alış-verişə davam et
        </a>
    </div>
    {% endif %}
</div>



<!-- Notification -->
<div id="notification" class="notification"></div>

<div id="cart-modal" class="cart-modal">
    <div class="cart-modal-content">
        <span class="close-btn" onclick="closeCartModal()">&times;</span>
        <h2>Səbətiniz</h2>
        <div class="cart-items">
            <!-- Səbət məhsulları burada göstəriləcək -->
        </div>
    </div>
</div>

<style>
.cart-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
}

.cart-modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;
    animation: fadeIn 0.5s;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/cart.js' %}"></script>
<script>
function handleOrderSubmit(event) {
    event.preventDefault();
    
    if (confirm('Sifarişi təsdiqləmək istədiyinizə əminsiniz?')) {
        const form = event.target;
        
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (response.ok) {
                alert('Sifarişiniz uğurla qeydə alındı. Sifarişlərim səhifəsinə yönləndirilirsiniz.');
                window.location.href = '{% url "sifaris_izle" %}';
            } else {
                alert('Xəta baş verdi. Zəhmət olmasa yenidən cəhd edin.');
            }
        })
        .catch(error => {
            alert('Xəta baş verdi. Zəhmət olmasa yenidən cəhd edin.');
        });
    }
    return false;
}
</script>
{% endblock %}
