{% extends 'base.html' %}
{% load static %}

{% block title %}Səbət{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}
<div class="panel-overlay" id="cart-overlay"></div>
<div class="slide-in-panel" id="cart-panel">
    <button class="panel-close-btn" id="close-cart-panel">
        <i class="fas fa-arrow-right"></i>
    </button>
    
    <div class="panel-header">
        <h1>Səbətim</h1>
    </div>
    
    <div class="panel-content">
        {% if sebet %}
        <div class="cart-container">
            <table>
                <thead>
                    <tr>
                        <th>
                            <div class="custom-checkbox">
                                <input type="checkbox" id="selectAll" onchange="toggleAllItems(this)">
                                <label for="selectAll" class="sr-only">Hamısını Seç</label>
                            </div>
                        </th>
                        <th>Məhsul</th>
                        <th>Firma</th>
                        <th>Avtomobil</th>
                        <th>№</th>
                        <th>KOD</th>
                        <th>Mövcudluq</th>
                        <th>Miqdar</th>
                        <th>Qiymət</th>
                        <th>Cəmi</th>
                        <th>Sil</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in sebet %}
                    <tr data-item-id="{{ item.id }}" data-price="{{ item.mehsul.formatted_qiymet }}">
                        <td>
                            <div class="custom-checkbox">
                                <input type="checkbox" class="item-checkbox" id="item-{{ item.id }}" data-item-id="{{ item.id }}" onchange="updateTotalAmount()">
                                <label for="item-{{ item.id }}" class="sr-only">Məhsulu Seç</label>
                            </div>
                        </td>
                        <td>{{ item.mehsul.adi }}</td>
                        <td>{{ item.mehsul.brend.adi }}</td>
                        <td>{{ item.mehsul.marka.adi }}</td>
                        <td>{{ item.mehsul.brend_kod }}</td>
                        <td>{{ item.mehsul.oem }}</td>
                        <td>
                            {% if item.mehsul.stok == 0 %}
                                <span class="stock-status out-of-stock">
                                     Yoxdur
                                </span>
                            {% elif item.mehsul.stok <= 20 %}
                                <span class="stock-status low-stock">
                                    Az var
                                </span>
                            {% else %}
                                <span class="stock-status in-stock">
                                   Var
                                </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="quantity-controls">
                                <input type="number" 
                                       class="quantity-input" 
                                       value="{{ item.miqdar }}"
                                       min="1"
                                       max="999"
                                       data-item-id="{{ item.id }}"
                                       onchange="validateCartQuantity(this)"
                                       onkeyup="if(event.key === 'Enter') validateCartQuantity(this)"
                                       onblur="validateCartQuantity(this)"
                                       style="width: 60px; text-align: center;">
                            </div>
                        </td>
                        <td class="price">{{ item.mehsul.formatted_qiymet }} ₼</td>
                        <td class="item-total">{{ item.cemi }} ₼</td>
                        <td>
                            <form action="{% url 'sebetden_sil' item.id %}" method="post" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="delete-btn" title="Sil" onclick="return confirm('Məhsulu silmək istədiyinizə əminsiniz?')">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <div colspan="11" style="text-align: center; padding: 1.5rem;">
                <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(145deg, #0a1929, #1a2942); padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
                    <strong style="color: #64ffda; font-size: 1.2rem;">Seçilmiş Məhsulların Cəmi:</strong>
                    <span id="selected-total-amount" style="color: white; font-size: 1.2rem; font-weight: 600;">0 ₼</span>
                </div>
            </div>

            <div class="cart-actions">
                <button onclick="recalculateCart()" class="recalculate-btn" id="recalculateBtn">
                    <i class="fas fa-sync-alt"></i>
                    Yenidən Hesabla
                </button>
                <form id="orderForm" onsubmit="return handleOrderSubmit(event)">
                    {% csrf_token %}
                    <button type="submit" class="order-btn" id="orderButton" disabled>
                        <i class="fas fa-shopping-cart"></i>
                        Seçilmiş Məhsulları Sifariş Et
                    </button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="empty-cart">
            <i class="fas fa-shopping-cart"></i>
            <p>Səbətiniz boşdur</p>
            <a href="{% url 'umumi_baxis' %}" class="continue-shopping">
                Alış-verişə davam et
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- Loading Bar -->
<div id="loadingBar" class="loading-bar-container" style="display: none;">
    <div class="loading-bar-overlay">
        <div class="loading-bar-content">
            <div class="loading-bar-progress">
                <div class="loading-bar-fill"></div>
            </div>
            <div class="loading-bar-text">Yenidən hesablanır... <span class="loading-bar-percentage">0%</span></div>
        </div>
    </div>
</div>

<!-- Notification -->
<div id="notification" class="notification"></div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Səbət panelini avtomatik olaraq aç
        openCartPanel();
        
        // Bağlama düyməsi üçün event listener
        document.getElementById('close-cart-panel').addEventListener('click', closeCartPanel);
        
        // Panel xaricində klikləyərək bağlamaq
        document.getElementById('cart-overlay').addEventListener('click', closeCartPanel);
        
        // ESC düyməsi ilə bağlamaq
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCartPanel();
            }
        });
        
        // Səbət panelini açmaqla yanaşı, 
        // digər inicializasiyaları da edirik
        updateOrderButton();
        
        // Səhifə yüklənərkən cəmi hesabla
        updateTotalAmount();
        
        // Miqdar dəyişdikdə cəmi yenilə
        const quantityInputs = document.querySelectorAll('.quantity-input');
        quantityInputs.forEach(input => {
            input.addEventListener('change', function() {
                // Miqdar dəyişdikdə cəmi yenilə
                setTimeout(updateTotalAmount, 500);
            });
        });
    });
    
    function openCartPanel() {
        document.getElementById('cart-panel').classList.add('active');
        document.getElementById('cart-overlay').classList.add('active');
        document.body.classList.add('panel-open');
    }
    
    function closeCartPanel() {
        document.getElementById('cart-panel').classList.remove('active');
        document.getElementById('cart-overlay').classList.remove('active');
        document.body.classList.remove('panel-open');
        
        // Ana səhifəyə qayıt
        setTimeout(function() {
            window.history.back();
        }, 300);
    }
    
    function toggleAllItems(checkbox) {
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        itemCheckboxes.forEach(item => {
            item.checked = checkbox.checked;
        });
        updateTotalAmount();
        updateOrderButton();
    }
    
    function updateTotalAmount() {
        let total = 0;
        const checkedItems = document.querySelectorAll('.item-checkbox:checked');
        
        checkedItems.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const itemTotalText = row.querySelector('.item-total').textContent.trim();
            
            // Vergül və nöqtə işarələrini düzgün emal et
            // "1168,70 AZN" formatını "1168.70" formatına çevir
            const numericValue = itemTotalText
                .replace(' AZN', '')  // "AZN" yazısını sil
                .replace(',', '.')    // vergülü nöqtə ilə əvəz et
                .trim();              // əlavə boşluqları sil
            
            const itemTotal = parseFloat(numericValue);
            
            if (!isNaN(itemTotal)) {
                total += itemTotal;
            } else {
                console.error('Xətalı məbləğ formatı:', itemTotalText);
            }
        });
        
        // Məbləği formatla: nöqtəni vergüllə əvəz et və AZN əlavə et
        const formattedTotal = total.toFixed(2).replace('.', ',') + ' AZN';
        document.getElementById('selected-total-amount').textContent = formattedTotal;
        
        // Debug məlumatı
        console.log('Hesablanmış cəmi:', total.toFixed(2));
        console.log('Formatlanmış cəmi:', formattedTotal);
        
        updateOrderButton();
    }
    
    function updateOrderButton() {
        const checkedItems = document.querySelectorAll('.item-checkbox:checked');
        const orderButton = document.getElementById('orderButton');
        orderButton.disabled = checkedItems.length === 0;
    }
    
    function handleOrderSubmit(event) {
        event.preventDefault();
        
        const checkedItems = document.querySelectorAll('.item-checkbox:checked');
        if (checkedItems.length === 0) {
            alert('Zəhmət olmasa ən azı bir məhsul seçin');
            return false;
        }
        
        if (confirm('Seçilmiş məhsulları sifariş etmək istədiyinizə əminsiniz?')) {
            const selectedItemIds = Array.from(checkedItems).map(checkbox => 
                checkbox.getAttribute('data-item-id')
            );
            
            fetch('{% url "sifarisi_gonder" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    selected_items: selectedItemIds
                })
            })
            .then(response => {
                if (response.ok) {
                    alert('Sifarişiniz uğurla qeydə alındı.');
                    window.location.href = '{% url "view_cart" %}';
                } else {
                    alert('Xəta baş verdi. Zəhmət olmasa yenidən cəhd edin.');
                }
            })
            .catch(error => {
                alert('Xəta baş verdi. Zəhmət olmasa yenidən cəhd edin.');
            });
        }
    }
    
    function recalculateCart() {
        const loadingBar = document.getElementById('loadingBar');
        const progressBar = loadingBar.querySelector('.loading-bar-fill');
        const percentageText = loadingBar.querySelector('.loading-bar-percentage');
        const loadingText = loadingBar.querySelector('.loading-bar-text');
        const recalculateBtn = document.getElementById('recalculateBtn');
        
        // Düyməni deaktiv et
        recalculateBtn.disabled = true;
        recalculateBtn.style.opacity = '0.7';
        
        // Loading bar-ı göstər
        loadingBar.style.display = 'block';
        
        // Əvvəlcə cəmi yenidən hesabla
        updateTotalAmount();
        
        // Hesablama mərhələlərini göstər
        const steps = [
            "Məlumatlar yüklənir...",
            "Məbləğlər yoxlanılır...",
            "Cəmi hesablanır...",
            "Tamamlanır..."
        ];
        
        let progress = 0;
        const duration = 3000; // 3 saniyə
        const interval = 30; // Hər 30ms-də yenilənir
        const increment = (100 * interval) / duration;
        const stepSize = 100 / steps.length;
        
        const updateProgress = setInterval(() => {
            progress += increment;
            
            // Cari mərhələni göstər
            const currentStep = Math.min(Math.floor(progress / stepSize), steps.length - 1);
            loadingText.innerHTML = `${steps[currentStep]} <span class="loading-bar-percentage">${Math.round(progress)}%</span>`;
            
            if (progress >= 100) {
                progress = 100;
                clearInterval(updateProgress);
                
                // Tamamlandı mesajını göstər
                loadingText.innerHTML = `Tamamlandı! <span class="loading-bar-percentage">100%</span>`;
                
                // 1 saniyə sonra səhifəni yenilə
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            }
            
            progressBar.style.width = `${progress}%`;
        }, interval);
    }
</script>
{% endblock %}
