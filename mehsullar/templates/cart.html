{% extends 'base.html' %}
{% load static %}

{% block title %}Səbət{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/cart.css' %}">
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
       
        <h1>Səbətim</h1>
    </div>

    {% if sebet %}
    <div class="cart-container">
        <table>
            <thead>
                <tr>
                    <th>
                        <div class="custom-checkbox">
                            <input type="checkbox" id="selectAll" onchange="toggleAllItems(this)">
                            <label for="selectAll" class="sr-only">Hamısını Seç</label>
                        </div>
                    </th>
                    <th>Məhsul</th>
                    <th>Firma</th>
                    <th>Avtomobil</th>
                    <th>Brend</th>
                    <th>OEM</th>
                    <th>Mövcudluq</th>
                    <th>Miqdar</th>
                    <th>Qiymət</th>
                    <th>Cəmi</th>
                    <th>Sil</th>
                </tr>
            </thead>
            <tbody>
                {% for item in sebet %}
                <tr data-item-id="{{ item.id }}" data-price="{{ item.mehsul.formatted_qiymet }}">
                    <td>
                        <div class="custom-checkbox">
                            <input type="checkbox" class="item-checkbox" id="item-{{ item.id }}" data-item-id="{{ item.id }}" onchange="updateTotalAmount()">
                            <label for="item-{{ item.id }}" class="sr-only">Məhsulu Seç</label>
                        </div>
                    </td>
                    <td>{{ item.mehsul.adi }}</td>
                    <td>{{ item.mehsul.brend.adi }}</td>
                    <td>{{ item.mehsul.marka.adi }}</td>
                    <td>{{ item.mehsul.brend_kod }}</td>
                    <td>{{ item.mehsul.oem }}</td>
                    <td>
                        {% if item.mehsul.stok == 0 %}
                            <span class="stock-status out-of-stock">
                                 Yoxdur
                            </span>
                        {% elif item.mehsul.stok <= 20 %}
                            <span class="stock-status low-stock">
                                Az var
                            </span>
                        {% else %}
                            <span class="stock-status in-stock">
                               Var
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="quantity-controls">
                            {% comment %} <button type="button" class="quantity-btn minus" onclick="updateQuantity({{ item.id }}, -1)">
                                <i class="fas fa-minus"></i>
                            </button> {% endcomment %}
                            <input type="number" 
                                   class="quantity-input" 
                                   value="{{ item.miqdar }}"
                                   min="1"
                                   max="999"
                                   data-item-id="{{ item.id }}"
                                   onchange="validateCartQuantity(this)"
                                   onkeyup="if(event.key === 'Enter') validateCartQuantity(this)"
                                   onblur="validateCartQuantity(this)"
                                   style="width: 60px; text-align: center;">
                            {% comment %} <button type="button" class="quantity-btn plus" onclick="updateQuantity({{ item.id }}, 1)">
                                <i class="fas fa-plus"></i>
                            </button> {% endcomment %}
                        </div>
                    </td>
                    <td class="price">{{ item.mehsul.formatted_qiymet }} AZN</td>
                    <td class="item-total">{{ item.cemi }} AZN</td>
                    <td>
                        <form action="{% url 'sebetden_sil' item.id %}" method="post" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="delete-btn" title="Sil" onclick="return confirm('Məhsulu silmək istədiyinizə əminsiniz?')">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            {% comment %} <tfoot>
                <tr>
                    <td colspan="11" style="text-align: center; padding: 1.5rem;">
                        <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(145deg, #0a1929, #1a2942); padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
                            <strong style="color: #64ffda; font-size: 1.2rem;">Ümumi Cəmi:</strong>
                            <span id="total-amount" style="color: white; font-size: 1.2rem; font-weight: 600;">{{ cemi_mebleg }} AZN</span>
                        </div>
                    </td>
                </tr>
            </tfoot> {% endcomment %}
        </table>

        <div colspan="11" style="text-align: center; padding: 1.5rem;">
            <div style="display: inline-flex; align-items: center; gap: 1rem; background: linear-gradient(145deg, #0a1929, #1a2942); padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
                <strong style="color: #64ffda; font-size: 1.2rem;">Seçilmiş Məhsulların Cəmi:</strong>
                <span id="selected-total-amount" style="color: white; font-size: 1.2rem; font-weight: 600;">0 AZN</span>
            </div>
        </div>

        <div class="cart-actions">
            <button onclick="recalculateCart()" class="recalculate-btn" id="recalculateBtn">
                <i class="fas fa-sync-alt"></i>
                Yenidən Hesabla
            </button>
            <form id="orderForm" onsubmit="return handleOrderSubmit(event)">
                {% csrf_token %}
                <button type="submit" class="order-btn" id="orderButton" disabled>
                    <i class="fas fa-shopping-cart"></i>
                    Seçilmiş Məhsulları Sifariş Et
                </button>
            </form>
        </div>
    </div>
    {% else %}
    <div class="empty-cart">
        <i class="fas fa-shopping-cart"></i>
        <p>Səbətiniz boşdur</p>
        <a href="{% url 'products_list' %}" class="continue-shopping">
            Alış-verişə davam et
        </a>
    </div>
    {% endif %}
</div>

<!-- Loading Bar -->
<div id="loadingBar" class="loading-bar-container" style="display: none;">
    <div class="loading-bar-overlay">
        <div class="loading-bar-content">
            <div class="loading-bar-progress">
                <div class="loading-bar-fill"></div>
            </div>
            <div class="loading-bar-text">Yenidən hesablanır... <span class="loading-bar-percentage">0%</span></div>
        </div>
    </div>
</div>

<!-- Notification -->
<div id="notification" class="notification"></div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
    function toggleAllItems(checkbox) {
        const itemCheckboxes = document.querySelectorAll('.item-checkbox');
        itemCheckboxes.forEach(item => {
            item.checked = checkbox.checked;
        });
        updateTotalAmount();
        updateOrderButton();
    }
    
    function updateTotalAmount() {
        let total = 0;
        const checkedItems = document.querySelectorAll('.item-checkbox:checked');
        
        checkedItems.forEach(checkbox => {
            const row = checkbox.closest('tr');
            const itemTotalText = row.querySelector('.item-total').textContent;
            // AZN-i kənarlaşdırıb, vergülü nöqtə ilə əvəz edirik
            const itemTotal = parseFloat(itemTotalText.replace('AZN', '').replace(',', '.').trim());
            if (!isNaN(itemTotal)) {
                total += itemTotal;
            }
        });
        
        // Onluq kəsrləri qoruyaraq formatlaşdırırıq
        document.getElementById('selected-total-amount').textContent = total.toFixed(2) + ' AZN';
        updateOrderButton();
    }
    
    function updateOrderButton() {
        const checkedItems = document.querySelectorAll('.item-checkbox:checked');
        const orderButton = document.getElementById('orderButton');
        orderButton.disabled = checkedItems.length === 0;
    }
    
function handleOrderSubmit(event) {
    event.preventDefault();
    
        const checkedItems = document.querySelectorAll('.item-checkbox:checked');
        if (checkedItems.length === 0) {
            alert('Zəhmət olmasa ən azı bir məhsul seçin');
            return false;
        }
        
        if (confirm('Seçilmiş məhsulları sifariş etmək istədiyinizə əminsiniz?')) {
            const selectedItemIds = Array.from(checkedItems).map(checkbox => 
                checkbox.getAttribute('data-item-id')
            );
            
            fetch('{% url "sifarisi_gonder" %}', {
            method: 'POST',
            headers: {
                    'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    selected_items: selectedItemIds
                })
        })
        .then(response => {
            if (response.ok) {
                alert('Sifarişiniz uğurla qeydə alındı. Sifarişlərim səhifəsinə yönləndirilirsiniz.');
                window.location.href = '{% url "sifaris_izle" %}';
            } else {
                alert('Xəta baş verdi. Zəhmət olmasa yenidən cəhd edin.');
            }
        })
        .catch(error => {
            alert('Xəta baş verdi. Zəhmət olmasa yenidən cəhd edin.');
        });
    }
    return false;
}
    
    // Initialize order button state
    document.addEventListener('DOMContentLoaded', function() {
        updateOrderButton();
        
        // Checkbox-ların dəyişməsini izlə
        document.querySelectorAll('.item-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                updateTotalAmount();
                
                // Checkbox seçildikdə animasiya
                const row = this.closest('tr');
                if (this.checked) {
                    row.classList.add('highlight');
                    setTimeout(() => row.classList.remove('highlight'), 300);
                }
            });
        });
        
        // Miqdar inputlarına event listener əlavə et
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('change', function() {
                // Miqdar dəyişdikdə cəmi yenilə
                setTimeout(() => {
                    updateTotalAmount();
                }, 500); // Serverdən cavab gəldikdən sonra yenilə
            });
        });
        
        // İlkin cəmi hesabla
        updateTotalAmount();
    });
    
    function recalculateCart() {
        const loadingBar = document.getElementById('loadingBar');
        const progressBar = loadingBar.querySelector('.loading-bar-fill');
        const percentageText = loadingBar.querySelector('.loading-bar-percentage');
        const recalculateBtn = document.getElementById('recalculateBtn');
        
        // Düyməni deaktiv et
        recalculateBtn.disabled = true;
        recalculateBtn.style.opacity = '0.7';
        
        // Loading bar-ı göstər
        loadingBar.style.display = 'block';
        
        let progress = 0;
        const duration = 3000; // 3 saniyə
        const interval = 30; // Hər 30ms-də yenilənir
        const increment = (100 * interval) / duration;
        
        const updateProgress = setInterval(() => {
            progress += increment;
            if (progress >= 100) {
                progress = 100;
                clearInterval(updateProgress);
                
                // 3 saniyə sonra səhifəni yenilə
                setTimeout(() => {
                    window.location.reload();
                }, 100);
            }
            
            progressBar.style.width = `${progress}%`;
            percentageText.textContent = `${Math.round(progress)}%`;
        }, interval);
    }

    function validateCartQuantity(input) {
        const value = parseInt(input.value);
        const itemId = input.getAttribute('data-item-id');
        
        if (isNaN(value) || value < 1) {
            input.value = 1;
            showNotification('Minimum miqdar 1 olmalıdır', 'error');
            updateCartItem(itemId, 1);
        } else if (value > 999) {
            input.value = 999;
            showNotification('Maksimum miqdar 999 olmalıdır', 'error');
            updateCartItem(itemId, 999);
        } else {
            updateCartItem(itemId, value);
        }
    }
    
    function updateCartItem(itemId, quantity) {
        const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
        const priceText = row.querySelector('.price').textContent;
        const price = parseFloat(priceText.replace('AZN', '').replace(',', '.').trim());
        
        // Loading göstər
        const input = row.querySelector('.quantity-input');
        input.disabled = true;
        
        const loadingIcon = document.createElement('span');
        loadingIcon.className = 'loading-icon';
        loadingIcon.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        input.parentNode.appendChild(loadingIcon);
        
        fetch(`/update_quantity/${itemId}/${quantity}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Sətir cəmini yenilə
                const itemTotal = data.item_total;
                row.querySelector('.item-total').textContent = itemTotal.toFixed(2) + ' AZN';
                
                // Seçilmiş məhsulların cəmini yenilə
                updateTotalAmount();
                
                // Sətri vurğula
                row.classList.add('highlight');
                setTimeout(() => row.classList.remove('highlight'), 300);
            } else {
                showNotification(data.error || 'Xəta baş verdi', 'error');
                input.value = input.defaultValue;
            }
        })
        .catch(error => {
            console.error('Xəta:', error);
            showNotification('Server xətası baş verdi', 'error');
            input.value = input.defaultValue;
        })
        .finally(() => {
            // Loading-i təmizlə
            input.disabled = false;
            const loadingIcon = row.querySelector('.loading-icon');
            if (loadingIcon) {
                loadingIcon.remove();
            }
        });
    }
    
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }
    
    // CSS stilləri
    const cartStyles = document.createElement('style');
    cartStyles.textContent = `
        .highlight {
            animation: highlight 0.3s ease;
        }

        @keyframes highlight {
            0% {
                background-color: transparent;
            }
            50% {
                background-color: rgba(100, 255, 218, 0.2);
            }
            100% {
                background-color: transparent;
            }
        }
        
        .loading-icon {
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--accent-color);
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: -400px;
            padding: 15px 25px;
            border-radius: 8px;
            background-color: var(--success-color);
            color: white;
            z-index: 1000;
            transition: right 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .notification.show {
            right: 20px;
        }
    `;
    document.head.appendChild(cartStyles);
</script>
{% endblock %}
