{% load static %}
<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Seller Panel{% endblock %}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="icon" type="image/png" href="{% static 'images/favicon.png' %}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="sidebar-header">
                <a href="{% url 'seller_admin_panel' %}" class="admin-panel-link {% if request.resolver_match.url_name == 'seller_admin_panel' %}active{% endif %}">
                    <i class="fas fa-cogs"></i> Seller Panel
                </a>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="sidebar-nav-item {% if request.resolver_match.url_name == 'my_products' %}active{% endif %}">
                        <a href="{% url 'my_products' %}"><i class="fas fa-box"></i> My Products</a>
                    </li>
                    <li class="sidebar-nav-item {% if request.resolver_match.url_name == 'my_sales' %}active{% endif %}">
                        <a href="{% url 'my_sales' %}" id="sidebarMySalesLink">
                            <i class="fas fa-receipt"></i> Incoming Orders
                            <span id="salesBadge" class="sales-badge-sidebar" style="display:none; margin-left:8px; background:#dc3545;color:white;border-radius:10px;padding:2px 8px;font-size:12px;font-weight:bold;vertical-align:middle;">0</span>
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>
        <!-- Main Content -->
        <div class="admin-main">
            <!-- Header -->
            <header class="admin-header">
                <div class="admin-header-left">
                    <span class="admin-header-title">{% if request.resolver_match.url_name == 'seller_admin_panel' %}Dashboard{% else %}{% block panel_title %}Seller Panel{% endblock %}{% endif %}</span>
                </div>
                <div class="admin-header-right">
                    <span class="admin-user">
                        <img src="{{ request.user.profile.sekil.url|default:'/static/images/no_image.jpg' }}" alt="Profil şəkli" class="admin-user-avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;margin-right:8px;vertical-align:middle;">
                        {{ request.user.username }}
                    </span>
                    <a href="{% url 'base' %}" class="admin-site-link" style="margin-right: 16px;"><i class="fas fa-globe"></i> View Site</a>
                    <a href="{% url 'logout' %}" class="admin-logout"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </header>
            <main class="admin-content">
                {% if request.resolver_match.url_name == 'seller_admin_panel' %}
                <!-- Dashboard Content -->
                <div class="dashboard-container">
                    <!-- Welcome Section -->
                    <div class="welcome-section mb-4">
                        <h1 class="dashboard-title">Welcome, {{ request.user.username }}!</h1>
                    </div>

                    <!-- Statistics Cards -->
                    <div class="stats-grid mb-4">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-number">{{ total_products }}</h3>
                                <p class="stat-label">Total Products</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-star"></i>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-number">{{ new_products }}</h3>
                                <p class="stat-label">New Products</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-number">{{ total_orders }}</h3>
                                <p class="stat-label">Total Orders</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-content">
                                <h3 class="stat-number">{{ total_sales|floatformat:2 }} ₼</h3>
                                <p class="stat-label">Total Sales</p>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Orders and Top Buyers -->
                    <div class="dashboard-row mb-4">
                        <div class="dashboard-col">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3>Recent Orders</h3>
                                    <a href="{% url 'my_sales' %}" class="view-all-link">View All</a>
                                </div>
                                <div class="card-body">
                                    {% if recent_orders %}
                                    <div class="recent-orders">
                                        {% for order_data in recent_orders %}
                                        <div class="order-item">
                                            <div class="order-info">
                                                <span class="order-number">#{{ order_data.order.id }}</span>
                                                <span class="order-customer">{{ order_data.order.istifadeci.username }}</span>
                                            </div>
                                            <div class="order-amount">
                                                <span class="amount">{{ order_data.total|floatformat:2 }} ₼</span>
                                                <span class="order-date">{{ order_data.order.tarix|date:"d.m.Y" }}</span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-receipt"></i>
                                        <p>No orders yet</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-col">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3>Top Buyers</h3>
                                </div>
                                <div class="card-body">
                                    {% if top_buyers %}
                                    <div class="top-buyers">
                                        {% for buyer in top_buyers %}
                                        <div class="buyer-item">
                                            <div class="buyer-info">
                                                <span class="buyer-name">{{ buyer.username }}</span>
                                                <span class="buyer-orders">{{ buyer.order_count }} orders</span>
                                            </div>
                                            <div class="buyer-amount">
                                                <span class="amount">{{ buyer.total_amount|floatformat:2 }} ₼</span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-users"></i>
                                        <p>No buyers yet</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Brands -->
                    <div class="dashboard-row">
                        <div class="dashboard-col">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3>Top Brands</h3>
                                </div>
                                <div class="card-body">
                                    {% if top_brands %}
                                    <div class="top-brands">
                                        {% for brand, count in top_brands %}
                                        <div class="brand-item">
                                            <div class="brand-info">
                                                <span class="brand-name">{{ brand }}</span>
                                            </div>
                                            <div class="brand-count">
                                                <span class="count">{{ count }} products</span>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% else %}
                                    <div class="empty-state">
                                        <i class="fas fa-tags"></i>
                                        <p>No brands yet</p>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-col">
                            <div class="dashboard-card">
                                <div class="card-header">
                                    <h3>Quick Actions</h3>
                                </div>
                                <div class="card-body">
                                    <div class="quick-actions">
                                        <a href="{% url 'add_product' %}" class="quick-action-btn">
                                            <i class="fas fa-plus"></i>
                                            <span>Add New Product</span>
                                        </a>
                                        <a href="{% url 'my_products' %}" class="quick-action-btn">
                                            <i class="fas fa-box"></i>
                                            <span>My Products</span>
                                        </a>
                                        <a href="{% url 'my_sales' %}" class="quick-action-btn">
                                            <i class="fas fa-receipt"></i>
                                            <span>Orders</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                {% block content %}{% endblock %}
                {% endif %}
            </main>
            <footer class="admin-footer">
                <span>&copy; {{ now|date:'Y' }} AS-AVTO Seller Panel. All rights reserved.</span>
            </footer>
        </div>
    </div>
    <!-- Şəkil Modalı -->
    <div id="imageModal" class="image-modal" style="display:none;">
        <span class="image-modal-close" style="position:absolute;right:20px;top:20px;cursor:pointer;font-size:24px;">&times;</span>
        <div class="modal-image-content">
            <img id="modalImage" class="modal-image" src="" alt="Modal Image" style="max-width:100%;max-height:80vh;display:block;margin:auto;">
        </div>
    </div>
    <!-- İstifadəçi Detalları Modalı -->
    <div id="userDetailsModal" class="details-modal" style="display:none;">
        <div class="details-modal-content">
            <span class="user-details-modal-close" style="position:absolute;right:20px;top:20px;cursor:pointer;font-size:24px;">&times;</span>
            <div class="details-content">
                <div class="details-header">
                    <h3>User Information</h3>
                </div>
                <div class="details-body">
                    <div class="details-info text-center">
                        <img id="userDetailsImage" src="" alt="Profil şəkli" style="width:80px;height:80px;border-radius:50%;object-fit:cover;margin-bottom:10px;">
                        <div class="info-row">
                            <span class="info-label">Username:</span>
                            <span id="userDetailsUsername" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Phone:</span>
                            <span id="userDetailsPhone" class="info-value"></span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Address:</span>
                            <span id="userDetailsAddress" class="info-value"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="{% static 'js/base.js' %}"></script>
    {% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Real-time sales badge və mesaj səsi üçün kod
    (function() {
        let lastSalesCount = parseInt(localStorage.getItem('lastSalesCount') || '0', 10);
        function playSalesSound() {
            try {
                const audio = new Audio('/static/sounds/new_order.mp3');
                audio.currentTime = 0;
                audio.play().catch(() => {});
            } catch (e) {}
        }
        function updateSalesBadge(count) {
            const badge = document.getElementById('salesBadge');
            if (!badge) return;
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'inline-block';
            } else {
                badge.textContent = '0';
                badge.style.display = 'none';
            }
        }
        function pollSalesCount() {
            fetch('/api/unread-sales-count/', { credentials: 'same-origin' })
                .then(res => res.json())
                .then(data => {
                    if (typeof data.count === 'number') {
                        updateSalesBadge(data.count);
                        if (data.count > lastSalesCount) {
                            playSalesSound();
                        }
                        lastSalesCount = data.count;
                        localStorage.setItem('lastSalesCount', lastSalesCount);
                    }
                });
        }
        setInterval(pollSalesCount, 10000);
        pollSalesCount();
        // Linkə kliklədikdə sayğacı sıfırla
        const salesLink = document.getElementById('sidebarMySalesLink');
        if (salesLink) {
            salesLink.addEventListener('click', function() {
                fetch('/api/unread-sales-count/', { method: 'POST', credentials: 'same-origin' })
                    .then(() => {
                        updateSalesBadge(0);
                        lastSalesCount = 0;
                        localStorage.setItem('lastSalesCount', '0');
                    });
            });
        }
    })();
    </script>
    {% endblock %}
</body>
</html> 