{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="chat-widget" id="chatWidget">
    <div class="chat-toggle" onclick="toggleChat()">
        <i class="fas fa-comments"></i>
        <span class="unread-count" id="unreadCount"></span>
    </div>
    
    <div class="chat-container" id="chatContainer" style="display: none;">
        <div class="chat-header">
            <h3>Mesajlar</h3>
            <button class="close-chat" onclick="toggleChat()">×</button>
        </div>
        
        <div class="chat-users">
            {% for user in users %}
            <div class="user-item" onclick="loadChat({{ user.id }}, '{{ user.username }}')">
                <img src="{{ user.profile.sekil.url }}" alt="{{ user.username }}" class="user-avatar">
                <span>{{ user.get_full_name|default:user.username }}</span>
            </div>
            {% endfor %}
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="no-chat-selected">Söhbət başlatmaq üçün istifadəçi seçin</div>
        </div>
        
        <div class="chat-input" style="display: none;">
            <input type="text" id="messageInput" placeholder="Mesajınızı yazın...">
            <button onclick="sendMessage()">Göndər</button>
        </div>
    </div>
</div>

<style>
.chat-widget {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.chat-toggle {
    width: 60px;
    height: 60px;
    background-color: #003366;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.chat-toggle i {
    color: white;
    font-size: 24px;
}

.unread-count {
    position: absolute;
    top: -5px;
    right: -5px;
    background-color: #ff4444;
    color: white;
    border-radius: 50%;
    padding: 2px 6px;
    font-size: 12px;
    display: none;
}

.chat-container {
    position: fixed;
    bottom: 90px;
    right: 20px;
    width: 300px;
    height: 400px;
    background-color: white;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
}

.chat-header {
    padding: 10px;
    background-color: #003366;
    color: white;
    border-radius: 10px 10px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-header h3 {
    margin: 0;
    font-size: 16px;
}

.close-chat {
    background: none;
    border: none;
    color: white;
    font-size: 20px;
    cursor: pointer;
}

.chat-users {
    padding: 10px;
    border-bottom: 1px solid #eee;
    max-height: 100px;
    overflow-y: auto;
}

.user-item {
    display: flex;
    align-items: center;
    padding: 5px;
    cursor: pointer;
    border-radius: 5px;
}

.user-item:hover {
    background-color: #f5f5f5;
}

.user-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 10px;
}

.chat-messages {
    flex-grow: 1;
    padding: 10px;
    overflow-y: auto;
    background-color: #f5f5f5;
}

.message {
    margin-bottom: 10px;
    max-width: 80%;
}

.message.mine {
    margin-left: auto;
    background-color: #003366;
    color: white;
    border-radius: 15px 15px 0 15px;
    padding: 8px 12px;
}

.message.other {
    margin-right: auto;
    background-color: white;
    border-radius: 15px 15px 15px 0;
    padding: 8px 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
}

.message .time {
    font-size: 10px;
    opacity: 0.7;
    margin-top: 2px;
}

.chat-input {
    padding: 10px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 10px;
}

.chat-input input {
    flex-grow: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 20px;
    outline: none;
}

.chat-input button {
    background-color: #003366;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 20px;
    cursor: pointer;
}

.no-chat-selected {
    text-align: center;
    color: #666;
    margin-top: 20px;
}
</style>

<script>
let currentChatUser = null;

function toggleChat() {
    const container = document.getElementById('chatContainer');
    container.style.display = container.style.display === 'none' ? 'flex' : 'none';
}

function loadChat(userId, username) {
    currentChatUser = userId;
    const messagesDiv = document.getElementById('chatMessages');
    const inputDiv = document.querySelector('.chat-input');
    
    // Mesajları yüklə
    fetch(`/istifadeciler/chat/messages/${userId}/`)
        .then(response => response.json())
        .then(data => {
            messagesDiv.innerHTML = '';
            data.messages.forEach(message => {
                const messageHtml = `
                    <div class="message ${message.is_mine ? 'mine' : 'other'}">
                        ${message.content}
                        <div class="time">${message.timestamp}</div>
                    </div>
                `;
                messagesDiv.innerHTML += messageHtml;
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            inputDiv.style.display = 'flex';
        });
}

function sendMessage() {
    if (!currentChatUser) return;
    
    const input = document.getElementById('messageInput');
    const content = input.value.trim();
    if (!content) return;
    
    fetch('/istifadeciler/chat/send/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            receiver_id: currentChatUser,
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            const messagesDiv = document.getElementById('chatMessages');
            const messageHtml = `
                <div class="message mine">
                    ${data.message.content}
                    <div class="time">${data.message.timestamp}</div>
                </div>
            `;
            messagesDiv.innerHTML += messageHtml;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            input.value = '';
        }
    });
}

// Enter düyməsi ilə mesaj göndərmə
document.getElementById('messageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// Oxunmamış mesajları yoxla
function checkUnreadMessages() {
    fetch('/istifadeciler/chat/unread/')
        .then(response => response.json())
        .then(data => {
            const unreadCount = document.getElementById('unreadCount');
            if (data.count > 0) {
                unreadCount.textContent = data.count;
                unreadCount.style.display = 'block';
            } else {
                unreadCount.style.display = 'none';
            }
        });
}

// Hər 10 saniyədə bir yeni mesajları yoxla
setInterval(checkUnreadMessages, 10000);
checkUnreadMessages();

// CSRF token funksiyası
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %} 