{% extends 'base.html' %}
{% load static %}

{% block title %}Mesajlar{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Söhbətlər</h5>
                </div>
                <div class="card-body p-0">
                    <div class="chat-list-container">
                        <ul class="list-group chat-list" id="chat-list">
                            <!-- Söhbət siyahısı AJAX ilə doldurulacaq -->
                            <li class="list-group-item text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Yüklənir...</span>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex align-items-center">
                        <div class="chat-user-avatar me-2">
                            <img src="{% static 'img/default-avatar.png' %}" alt="Avatar" id="chat-user-avatar" class="rounded-circle" width="40">
                        </div>
                        <h5 class="mb-0" id="chat-user-name">Söhbət seçin</h5>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chat-messages" id="chat-messages">
                        <div class="text-center py-5">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <p>Söhbət başlatmaq üçün sol tərəfdən bir istifadəçi seçin</p>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <form id="message-form" class="d-none">
                        <div class="input-group">
                            <input type="text" id="message-input" class="form-control" placeholder="Mesajınızı yazın..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .chat-list-container {
        max-height: 500px;
        overflow-y: auto;
    }
    
    .chat-list .list-group-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .chat-list .list-group-item:hover {
        background-color: #f8f9fa;
    }
    
    .chat-list .list-group-item.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }
    
    .chat-messages {
        height: 400px;
        overflow-y: auto;
        padding: 15px;
    }
    
    .message {
        margin-bottom: 15px;
        max-width: 80%;
    }
    
    .message-sent {
        margin-left: auto;
        background-color: #007bff;
        color: white;
        border-radius: 15px 15px 0 15px;
        padding: 10px 15px;
    }
    
    .message-received {
        margin-right: auto;
        background-color: #f1f1f1;
        border-radius: 15px 15px 15px 0;
        padding: 10px 15px;
    }
    
    .message-time {
        font-size: 0.75rem;
        margin-top: 5px;
        text-align: right;
    }
    
    .message-sent .message-time {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .message-received .message-time {
        color: #6c757d;
    }
    
    .unread-badge {
        background-color: #dc3545;
        color: white;
        border-radius: 50%;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    
    .chat-user-info {
        overflow: hidden;
    }
    
    .chat-user-name {
        font-weight: bold;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .chat-last-message {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #6c757d;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let currentChatUserId = null;
        let chatUpdateInterval = null;
        
        // Söhbət siyahısını yüklə
        function loadChatList() {
            fetch('/api/messages/chat-list/')
                .then(response => response.json())
                .then(data => {
                    const chatList = document.getElementById('chat-list');
                    
                    if (data.chat_list.length === 0) {
                        chatList.innerHTML = `
                            <li class="list-group-item text-center">
                                <p class="mb-0">Heç bir söhbət tapılmadı</p>
                            </li>
                        `;
                        return;
                    }
                    
                    chatList.innerHTML = data.chat_list.map(chat => `
                        <li class="list-group-item ${currentChatUserId === chat.id ? 'active' : ''}" 
                            data-user-id="${chat.id}" onclick="selectChat(${chat.id})">
                            <div class="d-flex align-items-center">
                                <div class="chat-user-avatar me-2">
                                    <img src="${chat.avatar || '{% static "img/default-avatar.png" %}'}" 
                                         alt="${chat.username}" class="rounded-circle" width="40">
                                </div>
                                <div class="chat-user-info flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="chat-user-name">${chat.full_name}</div>
                                        <small class="text-muted">${chat.timestamp}</small>
                                    </div>
                                    <div class="chat-last-message">${chat.last_message}</div>
                                </div>
                                ${chat.unread_count > 0 ? 
                                    `<span class="unread-badge">${chat.unread_count}</span>` : ''}
                            </div>
                        </li>
                    `).join('');
                })
                .catch(error => {
                    console.error('Söhbət siyahısı yüklənərkən xəta:', error);
                });
        }
        
        // Mesajları yüklə
        function loadMessages(userId) {
            fetch(`/api/messages/${userId}/`)
                .then(response => response.json())
                .then(data => {
                    currentChatUserId = userId;
                    
                    // İstifadəçi məlumatlarını göstər
                    document.getElementById('chat-user-name').textContent = data.user.full_name;
                    document.getElementById('chat-user-avatar').src = data.user.avatar || '{% static "img/default-avatar.png" %}';
                    
                    // Mesaj formasını göstər
                    document.getElementById('message-form').classList.remove('d-none');
                    
                    // Mesajları göstər
                    const messagesContainer = document.getElementById('chat-messages');
                    messagesContainer.innerHTML = '';
                    
                    if (data.messages.length === 0) {
                        messagesContainer.innerHTML = `
                            <div class="text-center py-5">
                                <p>Hələ heç bir mesaj yoxdur. Söhbətə başlayın!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    data.messages.forEach(message => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `message ${message.is_sender ? 'message-sent' : 'message-received'}`;
                        messageElement.innerHTML = `
                            <div class="message-content">${message.content}</div>
                            <div class="message-time">
                                ${message.timestamp}
                                ${message.is_sender ? 
                                    `<i class="fas fa-${message.is_read ? 'check-double' : 'check'} ms-1"></i>` : ''}
                            </div>
                        `;
                        messagesContainer.appendChild(messageElement);
                    });
                    
                    // Söhbəti aşağı sürüşdür
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    
                    // Söhbət siyahısını yenilə (oxunmamış mesajları yeniləmək üçün)
                    loadChatList();
                })
                .catch(error => {
                    console.error('Mesajlar yüklənərkən xəta:', error);
                });
        }
        
        // Mesaj göndər
        document.getElementById('message-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!currentChatUserId) return;
            
            const messageInput = document.getElementById('message-input');
            const content = messageInput.value.trim();
            
            if (!content) return;
            
            fetch('/api/messages/send/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    receiver_id: currentChatUserId,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                // Mesaj inputunu təmizlə
                messageInput.value = '';
                
                // Yeni mesajı göstər
                const messagesContainer = document.getElementById('chat-messages');
                const messageElement = document.createElement('div');
                messageElement.className = 'message message-sent';
                messageElement.innerHTML = `
                    <div class="message-content">${data.content}</div>
                    <div class="message-time">
                        ${data.timestamp}
                        <i class="fas fa-check ms-1"></i>
                    </div>
                `;
                messagesContainer.appendChild(messageElement);
                
                // Söhbəti aşağı sürüşdür
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
                // Söhbət siyahısını yenilə
                loadChatList();
            })
            .catch(error => {
                console.error('Mesaj göndərilərkən xəta:', error);
            });
        });
        
        // Söhbət seçmə funksiyası
        window.selectChat = function(userId) {
            // Əvvəlki aktiv söhbəti təmizlə
            const activeChat = document.querySelector('.chat-list .list-group-item.active');
            if (activeChat) {
                activeChat.classList.remove('active');
            }
            
            // Yeni söhbəti aktiv et
            const newActiveChat = document.querySelector(`.chat-list .list-group-item[data-user-id="${userId}"]`);
            if (newActiveChat) {
                newActiveChat.classList.add('active');
            }
            
            // Mesajları yüklə
            loadMessages(userId);
            
            // Avtomatik yeniləmə intervalını təmizlə və yenidən başlat
            if (chatUpdateInterval) {
                clearInterval(chatUpdateInterval);
            }
            
            // Hər 10 saniyədə bir mesajları yenilə
            chatUpdateInterval = setInterval(() => {
                if (currentChatUserId) {
                    loadMessages(currentChatUserId);
                }
            }, 10000);
        };
        
        // İlkin yükləmə
        loadChatList();
        
        // Hər 30 saniyədə bir söhbət siyahısını yenilə
        setInterval(loadChatList, 30000);
        
        // CSRF token funksiyası
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock %} 